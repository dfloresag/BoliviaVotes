---
title: "Bolivia Vota"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      fig.width = 28, 
                      fig.height=7, cache =FALSE)
```

```{r, include = FALSE}
rm(list=ls())

library(ggplot2)
library(reshape)
library(dplyr)
library(knitr)
library(kableExtra)

partidos <- c(
  "CC","FPV","MTS","UCS","MAS...IPSP","X21F","PDC","MNR","PAN.BOL"
)

emitidos <-c(partidos, "Nulos", "Blancos") 
```

This document summarizes our attempts at finding voting tampering in the recent Bolivian elections. The datasets were obtained via the official polling authority Organo Electoral Plurinacional (OEP) at the website `http://computo.oep.org.bo`. 

For this purpose, we are considering two datasets:

- Results of the rapid counting process obtained on Sunday 22, October 2019 at 20:38:53 (GMT-4) that we shall call **TREP** sample. 
- Results of the computations Friday 25 October 2019 at 01:40:43(GMT-4), which we shall call the **PRES** sample. 

In what follows, we shall focus on the results for the election for President and Vicepresident of the Plurinational State. 

## Comparison between Valid Votes and Polling Booth aggregation.

As a first exercise, we consider the **PRES** sample. We aim to compare the following variables:

- `Votos.Válidos` : The total amount of votes per polling booth. 
- The aggregate of the votes for the political parties in the booth, that we shall store in a new variable called `Votos.Partidos`. 

Our hypothesis is that booths that show divergence between these two quantities are suspicious of being tampered, as their difference (`Votos.Partidos - Votos.Validos`) is expected to be zero. We shall identify these booths in the variable `Sospecha`

```{r, echo = FALSE}
actas      <- read.csv("./datasets/acta.2019.10.25.21.09.30.csv")

actas_pres <- actas %>%  
  filter(
    Elección  == "Presidente y Vicepresidente"
    )

actas_pres$Votos.Partidos <- 
  actas_pres[,partidos] %>% 
  rowSums()

actas_pres$Votos.Emitidos <- 
  actas_pres[,emitidos] %>% 
  rowSums()

actas_pres$Diferencia.Partidos <- 
  actas_pres$Votos.Partidos - actas_pres$Votos.Válidos

actas_pres %>% 
  mutate(
    Sospecha = ifelse(
      Diferencia.Partidos!=0,"Sospechosa","Normal"), 
    Sampl = "pres"
    ) -> actas_pres

Total.Sospechas <- sum(actas_pres$Sospecha=="Sospechosa") 

actas_pres %>% 
  filter(Sospecha == "Sospechosa")  %>%
  select(Diferencia.Partidos) %>%
  abs() %>%
  sum() -> Votos.Sospechosos

actas_pres %>% 
  select(Votos.Emitidos) %>% 
  sum() -> Total.Emitidos
```

The conclusions of this first exploration are as follows:

- A total of `r Total.Sospechas` booths were deemed as supicious. Given that the total amount of booths is `r nrow(actas_pres)`, this amount represents `r round(Total.Sospechas/nrow(actas_pres)*100, digits = 2)`% of the total number of booths.  
- A total of `r Votos.Sospechosos` were votes miscounted, be it in the positive or negative sense. That is, considering that the total amount of votes were `r Total.Emitidos`, this gives`r round(Votos.Sospechosos/Total.Emitidos*100, digits = 2)`% of the total amount of votes. 

These divergences range in the following way:
```{r, include = TRUE, echo = FALSE}

mysum <- function(x){
  x <- x[,1]
    Value <- unname(
      c(min(x) , 
        quantile(x, probs = 0.25),
        quantile(x, probs = 0.5),
        mean(x),
        quantile(x, probs = 0.75),
        max(x)
        )
      )
    Statistic <- c("Min", "1st Quartile", "Median", "Mean", "3rd Quartile", "Max")
    data.frame(Statistic, Value = round(Value, digits = 2))
  }
actas_pres %>% 
  filter(Sospecha == "Sospechosa")  %>%
  select(Diferencia.Partidos) %>% mysum() %>% kable() %>% kable_styling()
```
Negative median and mean indicates that the majority of these missing votes are _supressions_, i.e. Booths where the votes for the parties were less than the aggregates. 

If there is tampering in favor of MAS-IPSP, it is possible that:

- **Booths with a Negative difference** imply a supression of the vote of CC so that MAS-IPSP is the winner.
- **Booths where there is a Positive difference** imply an increase of the vote in favor of MAS-IPSP, making it the winner. 

Otherwise, the observed suppression or increase would be reflective of the proportions in the results of the election.

```{r, fig.width=7, fig.height=7, echo = FALSE}
actas_pres %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  group_by(Número.Mesa) %>% 
  filter(Sospecha == "Sospechosa", value == max(value)) %>%
  mutate(
    Diferencia.Positiva = ifelse(Diferencia.Partidos>0, "Incremento", "Supresión")
    ) %>%
  ggplot(mapping = aes(Tipo.de.Voto, fill = Diferencia.Positiva)) + 
  geom_bar(mapping = aes(y=..count../sum(..count..)*100), position = "dodge")
```

In this plot, we see that booths where the total voting was underreported (red bars) and overreported (blue bars) show the same behaviour. That is, we are not seeing the behaviour expected by some election tampering **in the sense that they reflect the final result of the vote**.

Further verification of this hypothesis namely requiring seeing whether the suppresed/increased votes per booth were indeed **penalizing for CC and beneficial to MAS-IPSP** require a comparison between the **PRES** and **TREP** samples. 

## Comparison between rapid counting and full report of the election results : the **TREP** vs. **PRES** samples.

```{r}
actas_trep <- read.csv("./datasets/acta.2019.10.22.20.38.53.csv")

actas_pres_trep <- actas_trep %>%  
  filter(
    Elección  == "Presidente y Vicepresidente"
    )

actas_pres_trep$Votos.Partidos <- 
  actas_pres_trep[,partidos] %>% 
  rowSums()

actas_pres_trep$Votos.Emitidos <- 
  actas_pres_trep[,emitidos] %>% 
  rowSums()

actas_pres_trep$Diferencia.Partidos <- 
  actas_pres_trep$Votos.Partidos - actas_pres_trep$Votos.Válidos

actas_pres_trep %>% 
  mutate(
    Sospecha = ifelse(
      Diferencia.Partidos!=0,"Sospechosa","Normal"), 
    Sampl = "pres"
    ) -> actas_pres_trep

Total.Sospechas_trep <- sum(actas_pres_trep$Sospecha=="Sospechosa") 

actas_pres_trep %>% 
  filter(Sospecha == "Sospechosa")  %>%
  select(Diferencia.Partidos) %>%
  abs() %>%
  sum() -> Votos.Sospechosos_trep

actas_pres_trep %>% 
  select(Votos.Emitidos) %>% 
  sum() -> Total.Emitidos_trep
```

- A total of `r Total.Sospechas_trep` booths were deemed as supicious. Given that the total amount of booths is `r nrow(actas_pres_trep)`, this amount represents `r round(Total.Sospechas_trep/nrow(actas_pres_trep)*100, digits = 2)`% of the total number of booths.  
- A total of `r Votos.Sospechosos_trep` were votes miscounted, be it in the positive or negative sense. That is over a total of `r Total.Emitidos_trep` accounted up to that point, `r round(Votos.Sospechosos_trep/Total.Emitidos_trep*100, digits = 2)`% of the total amount of votes. 

The summary goes as follows:

```{r}
actas_pres_trep %>% 
  filter(Sospecha == "Sospechosa")  %>%
  select(Diferencia.Partidos) %>% mysum() %>% kable() %>% kable_styling()
```

More votes are negatively corrected. 

```{r, message = FALSE}
actas_pres %>% 
  mutate(Computo = "Computo Final") -> actas_pres

actas_pres_trep %>% 
  mutate(Computo = "Conteo Rapido (TREP)") -> actas_pres_trep

actas_pres %>% 
  filter(Número.Mesa %in% actas_pres_trep$Número.Mesa) -> 
  actas_pres_mtch

# both datasets match

actas_pres_diff <- 
  select(actas_pres_mtch, emitidos) - select(actas_pres_trep, emitidos) 

actas_pres_diff %>% abs() %>% rowSums() -> alterations

actas_pres_mtch %>%
  mutate(alterations = ifelse(alterations!=0, "Altered", "Normal")) -> 
  actas_pres_mtch 

actas_pres_mtch[,emitidos] <- actas_pres_diff

actas_pres_mtch  %>% 
  filter(alterations == "Altered") -> actas_pres_altr
```


```{r}
actas_pres_altr %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  mutate(
    Alteration = ifelse(value>0, "Incremento", "Supresión")
    ) %>%
  ggplot(mapping = aes(Tipo.de.Voto, fill= Alteration)) + 
  # geom_bar(mapping = aes(y=..count../sum(..count..)*100), position = "dodge")
  geom_bar(position = "dodge")
```


Approximately all the candidates get the same amount of positive alterations. be


## 2. Overviewing voting per Polling Districts 

In this part, we try to check whether there is a difference between the results of voting at each booth within a precint and the results of the precint. One would expect that the distribution of the former is somehow reflective of the latter. This can be assessed graphically or via testing procedures with the respective corrections. 

However, booths with a small amount of voters:

1. Could have a problem reflecting the distribution of the precint as they are small samples.
2. Hinder the statistical testing process.

```{r}
ComoVotaMiRecinto <- function(recinto, porcentajes =FALSE){
   if(!(recinto %in% levels(actas$Recinto))) {
     stop(message("Nombre de recinto no valido."))
   } else {
     data <- actas_pres %>% melt(
       measure.vars  = partidos,
       variable_name= "Partido") %>%
       mutate(
         Porcentaje.por.Partido =  value/Votos.Emitidos*100) %>%
       filter(
         Recinto  == recinto) %>%
       group_by(Número.Mesa, Partido)
      if(!porcentajes){
        plots <- data %>% 
          ggplot(mapping = aes(x = Partido, 
                               y=value, 
                               fill = factor(Número.Mesa))) +
          geom_col(position ="dodge")+
          facet_grid(.~Departamento+Provincia+Localidad+Sospecha, 
                     scales = "free_y") + 
          ggtitle(paste("Localidad :", recinto, "- Total")) + 
          labs(x = "Partido", y = "Total de Votos")
       } else if (porcentajes){
         plots <- data %>% 
           ggplot(mapping = aes(x = Partido, 
                                y = Porcentaje.por.Partido, 
                                fill = factor(Número.Mesa))) +
           geom_col(position ="dodge")+
           facet_grid(.~Departamento+Provincia+Localidad+Sospecha, scales = "free_y") + 
           ggtitle(paste("Localidad :", recinto, "- Porcentaje por Mesa"))+ 
           labs(x = "Partido", y = "Porcentaje de Votos")
       }
     plots
   }
}
```

### Some Examples

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Colegio German Busch", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio German Busch", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Escuela Carlos Medinaceli", porcentajes = FALSE)
ComoVotaMiRecinto("Escuela Carlos Medinaceli", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Colegio Bolivia", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio Bolivia", porcentajes = TRUE)
```


```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Escuela Simón Bolivar", porcentajes = FALSE)
ComoVotaMiRecinto("Escuela Simón Bolivar", porcentajes = TRUE)
```


```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Escuela Alto Achumani", porcentajes = FALSE)
ComoVotaMiRecinto("Escuela Alto Achumani", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("U. E. Ff. Aa. De La Nación", porcentajes = FALSE)
ComoVotaMiRecinto("U. E. Ff. Aa. De La Nación", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Esc. San Jose", porcentajes = FALSE)
ComoVotaMiRecinto("Esc. San Jose", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("U.E. Ignacio Warnes", porcentajes = FALSE)
ComoVotaMiRecinto("U.E. Ignacio Warnes", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Colegio 6 de Junio", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio 6 de Junio", porcentajes = TRUE)
```

```{r, echo = FALSE}
ComoVotaMiRecinto("Colegio Simon Bolivar", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio Simon Bolivar", porcentajes = TRUE)
```

```{r}
ComoVotaMiRecinto("Colegio Simon Bolivar", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio Simon Bolivar", porcentajes = TRUE)
```




```{r, eval = FALSE}
ComoVotaMiRecinto <- function(recinto, porcentajes =FALSE, aggregation= FALSE){
   if(!(recinto %in% levels(actas$Recinto))) {
     stop(message("Nombre de recinto no valido."))
   } else {
     otpbn <-c("FPV","MTS","UCS","X21F","PDC","MNR","PAN.BOL","Nulos", "Blancos")
     data <- actas_pres %>% melt(
       measure.vars  = partidos,
       variable_name= "Partido") %>%
       mutate(
         Porcentaje.por.Partido =  value/Votos.Emitidos*100,
         Partido.OBN = ifelse((Partido %in% otpbn), "Otros-Blanco-Nulo", Partido)
         ) %>%
       filter(
         Recinto  == recinto) %>%
       group_by(Número.Mesa, Partido, Partido.OBN)
      if(!porcentajes){
        plots <- data %>% 
          ggplot(mapping = aes(x = ifelse(!aggregation,Partido,Partido.OBN), 
                               y=value, 
                               fill = factor(Número.Mesa))) +
          geom_col(position ="dodge")+
          facet_grid(.~Departamento+Provincia+Localidad+Sospecha, 
                     scales = "free_y") + 
          ggtitle(paste("Localidad :", recinto, "- Total")) + 
          labs(x = "Partido", y = "Total de Votos")
       } else if (porcentajes){
         plots <- data %>% 
           ggplot(mapping = aes(x = ifelse(!aggregation,Partido,Partido.OBN), 
                                y = Porcentaje.por.Partido, 
                                fill = factor(Número.Mesa))) +
           geom_col(position ="dodge")+
           facet_grid(.~Departamento+Provincia+Localidad+Sospecha, scales = "free_y") + 
           ggtitle(paste("Localidad :", recinto, "- Porcentaje por Mesa"))+ 
           labs(x = "Partido", y = "Porcentaje de Votos")
       }
     plots
   }
}
```