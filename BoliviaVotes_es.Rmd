---
title: "Bolivia Vota"
output: html_document

---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      fig.width = 16, 
                      fig.height= 8, cache =FALSE, 
                      fig.align = "center")
```

```{r, include = FALSE}
rm(list=ls())

library(ggplot2)
library(reshape)
library(dplyr)
library(knitr)
library(kableExtra)

partidos <- c(
  "CC","FPV","MTS","UCS","MAS...IPSP","X21F","PDC","MNR","PAN.BOL"
)

emitidos <-c(partidos, "Nulos", "Blancos") 
```

Este documento resume nuestros intentos de encontrar evidencia de alteración sistemática de votos durante las Elecciones Generales en Bolivia del 20 de Octubre 2019. Las bases de datos que estudiamos fueron obtenidas en el sitio del Órgano Electoral Plurinacional (OEP). 

<!-- This document summarizes our attempts at finding voting tampering in the recent Bolivian elections. The datasets were obtained via the official polling authority Organo Electoral Plurinacional (OEP) at the website `http://computo.oep.org.bo`.  -->

<!-- For this purpose, we are considering two datasets: -->

Para este análisis, se consideraron dos Bases de Datos:

- Los resultados del conteo rápido obtenidos el Martes 22 de Octubre de 2019 a las 20:38:53 (GMT-4) a la cual nos referimos como la muestra **TREP**.
- Resultados del Cómputo Final de Votos, obtenido el Viernes 25 de Octubre de 2019 a la 01:40:43(GMT-4). Nos referimos a esta muestra como **PRES**.

<!-- - Results of the rapid counting process obtained on Sunday 22, October 2019 at 20:38:53 (GMT-4) that we shall call **TREP** sample.  -->
<!-- - Results of the computations Friday 25 October 2019 at 01:40:43(GMT-4), which we shall call the **PRES** sample.  -->

<!-- In what follows, we shall focus on the results for the election for President and Vicepresident of the Plurinational State.  -->

Esta exploración concierne solamente la elección para Presidente y Vicepresidente del Estado Plurinacional

<!-- ## Comparison between Valid Votes and Polling Booth aggregation. -->

# Comparación entre Votos Válidos y Agregación de Votos entre partidos y Categorías

<!-- As a first exercise, we consider the **PRES** sample. We aim to compare the following variables: -->

Empezamos esta exploración considerando la muestra **PRES** con el objetivo de comparar las siguientes variables:

<!-- - `Votos.Válidos` : The total amount of votes per polling booth.  -->
<!-- - The aggregate of the votes for the political parties in the booth, that we shall store in a new variable called `Votos.Partidos`.  -->

- `Votos.Válidos` : Variable disponible en la Base de Datos original y que indica el número total de votos válidos emitidos (i.e. por los partidos) en cada Mesa electoral. 
- `Votos.Partidos`: Una variable creada a partir de la agregación (suma) de los votos emitidos a cada partido en cada mesa.

Se espera que la diferencia `Votos.Partidos - Votos.Válidos = 0` en todas las mesas de votación. Las mesas donde estas cantidades divergen son suscetibles de alteración fraudulenta. 

<!-- Our hypothesis is that booths that show divergence between these two quantities are suspicious of being tampered, as their difference  is expected to be zero. We shall identify these booths in the variable `Sospecha` -->

```{r, echo = FALSE}
actas      <- read.csv("./datasets/acta.2019.10.25.21.09.30.csv")

actas_pres <- actas %>%  
  filter(
    Elección  == "Presidente y Vicepresidente"
    )

actas_pres$Votos.Partidos <- 
  actas_pres[,partidos] %>% 
  rowSums()

actas_pres$Votos.Emitidos <- 
  actas_pres[,emitidos] %>% 
  rowSums()

actas_pres$Diferencia.Partidos <- 
  actas_pres$Votos.Partidos - actas_pres$Votos.Válidos

actas_pres %>% 
  mutate(
    Sospecha = ifelse(
      Diferencia.Partidos!=0,"Sospechosa","Normal"), 
    Sampl = "pres"
    ) -> actas_pres

Total.Sospechas <- sum(actas_pres$Sospecha=="Sospechosa") 

actas_pres %>% 
  filter(Sospecha == "Sospechosa")  %>%
  select(Diferencia.Partidos) %>%
  abs() %>%
  sum() -> Votos.Sospechosos

actas_pres %>% 
  select(Votos.Emitidos) %>% 
  sum() -> Total.Emitidos
```

<!-- The conclusions of this first exploration are as follows: -->

Esta primera exploración aporta las siguientes conclusiones:

- En total `r Total.Sospechas` mesas presentan divergencias. Dado que el total de mesas en la muestra es de `r nrow(actas_pres)`, esta cantidad representa el `r round(Total.Sospechas/nrow(actas_pres)*100, digits = 2)`% de las mesas
- En total `r Votos.Sospechosos` fueron mal contados, ya sea de manera positiva o negativa. Dado que la totalidad de votos suma `r Total.Emitidos`, esto representa `r round(Votos.Sospechosos/Total.Emitidos*100, digits = 2)`% de la votación. 

<!-- - A total of `r Total.Sospechas` booths were deemed as supicious. Given that the total amount of booths is `r nrow(actas_pres)`, this amount represents `r round(Total.Sospechas/nrow(actas_pres)*100, digits = 2)`% of the total number of booths.   -->
<!-- - A total of `r Votos.Sospechosos` were votes miscounted, be it in the positive or negative sense. That is, considering that the total amount of votes were `r Total.Emitidos`, this gives`r round(Votos.Sospechosos/Total.Emitidos*100, digits = 2)`% of the total amount of votes.  -->

Estas divergencias varían de la manera descrita en la siguiente tabla:
```{r, include = TRUE, echo = FALSE}

mysum <- function(x){
  x <- x[,1]
    Value <- unname(
      c(min(x) , 
        quantile(x, probs = 0.25),
        quantile(x, probs = 0.5),
        mean(x),
        quantile(x, probs = 0.75),
        max(x)
        )
      )
    Statistic <- c("Min", "1st Quartile", "Median", "Mean", "3rd Quartile", "Max")
    data.frame(Estadístico = Statistic, Valor = round(Value, digits = 2))
  }
actas_pres %>% 
  filter(Sospecha == "Sospechosa")  %>%
  select(Diferencia.Partidos) %>% mysum() %>% kable() %>% kable_styling()
```
<!-- Negative median and mean indicates that the majority of these missing votes are _supressions_, i.e. Booths where the votes for the parties were less than the aggregates.  -->

La Mediana y el Promedio de votos 'perdidos' son negativos, lo cual indicaría la posibilidad que hubiera una _supresión_ de votos, i.e. Pérdida de votos en favor de algún candidato. 

A este punto, corresponde analizar la posibildad que exista favoritismo para el partido de gobierno MAS-IPSP. Se pueden establecer los siguientes escenarios. 

- **Mesas con votos _perdidos_**: Los votos perdidos corresponden a CC y hacen que el  MAS-IPSP se declare ganador en la mesa. 
- **Mesas con votos _aumentados_**: los votos aumentados van a MAS-IPSP y hacen que se declare ganador en esa mesa. 

Se puede formular una hipótesis: Si la alteración tiene una influencia, esta probabilidad estimada no debe mostrar divergencias con respecto a la distribución de mesas ganadas por cada partido en toda la muestra. Desde un punto de vista probabilístico, esto equivale a verificar independencia entre los eventos "Partido Ganador" y "Mesa sospechosa", i.e.
$$
P(\text{Partido Ganador} \  | \ \text{Mesa Sospechosa})  = P(\text{Partido Ganador})
$$

En el gráfico siguiente, reportamos estimaciones de la probabilidad condicional que cada partido gane una mesa sospechosa de alteración (barras grises), i.e. 
$$ 
\widehat{P}(\text{Partido Ganador} \  | \ \text{Mesa Sospechosa}) 
= 
\frac{\# \text{Partido Ganador & Mesa Sospechosa}}
{\# \text{Mesa Sospechosa}}
$$
y las proporciones de mesas ganadas por cada partido en la muestra completa (barras de colores)
```{r}
actas_pres %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  group_by(Número.Mesa) %>% 
  filter(value == max(value)) -> actas_pres_winners

p_ganadores_mesas <- 100*(table(actas_pres_winners$Tipo.de.Voto)/
    sum(table(actas_pres_winners$Tipo.de.Voto)))
      
p_ganadores_mesas <- data.frame(
  Tipo.de.Voto = names(p_ganadores_mesas),  
  value = unname(as.vector(p_ganadores_mesas))
  )
```

```{r, fig.width=7, fig.height=7, echo = FALSE}
actas_pres %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  group_by(Número.Mesa) %>% 
  filter(value == max(value), Sospecha=="Sospechosa") %>%
  ggplot( mapping = aes(Tipo.de.Voto)) + 
  geom_bar(mapping = aes(y=..count../sum(..count..)*100)) +
  geom_col(data = p_ganadores_mesas, 
      aes(x = Tipo.de.Voto, y = value, fill = Tipo.de.Voto), 
      alpha = 0.35, position = "dodge"
      )
```

El gráfico muestra una diferencia importante entre dichas probabilidades. A este punto, podemos efectuar un test de ajuste. Para evitar problemas, se pueden aglomerar las mesas ganadoras de los otros partidos en una categoría llamada "otros ganadores". Sin embargo, como se puede ver en los siguientes resultados, este test no rechaza la Hipótesis de igualdad de ambas distribuciones. Además, la implementación advierte sobre la poca fiabilidad del resultado, dado que la categoría agregada no tiene muchas observaciones. 
<!-- $$  -->
<!-- P(\text{MAS-IPSP Ganador} \  | \ \text{Mesa Sospechosa \& Alteración Positiva})  -->
<!-- =  -->
<!-- \frac{\# \text{MAS-IPSP Ganador \& Mesa Sospechosa \& Alteración Positiva}} -->
<!-- {\# \text{Mesa Sospechosa \& Alteración Positiva}} -->
<!-- $$ -->

```{r, fig.width=7, fig.height=7, echo = FALSE, eval= TRUE}

actas_pres %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  group_by(Número.Mesa) %>% 
  filter(
    value == max(value)
    ) -> actas_pres_winners

actas_pres %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  group_by(Número.Mesa) %>% 
  filter(
    value == max(value), 
    Sospecha == "Sospechosa"
    ) -> actas_pres_sosp_winners

actas_pres %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  group_by(Número.Mesa) %>% 
  filter(
    value == max(value) 
    ) -> actas_pres_winners

otros_partidos = c(
  "FPV","MTS","UCS","X21F","PDC","MNR","PAN.BOL",  "Nulos", "Blancos")

op_pres <- sum(table(actas_pres_winners$Tipo.de.Voto)[otros_partidos])
op_sosp <- sum(table(actas_pres_sosp_winners$Tipo.de.Voto)[otros_partidos])

ap_pres <- c(table(actas_pres_winners$Tipo.de.Voto)[c("CC", "MAS...IPSP")], op_pres)
ap_sosp <- c(table(actas_pres_sosp_winners$Tipo.de.Voto)[c("CC", "MAS...IPSP")], op_sosp)

chisq.test(ap_sosp, ap_pres)
```

```{r}
# actas_pres %>%
#   melt(measure.vars  = emitidos,
#        variable_name= "Tipo.de.Voto"
#        ) %>% 
#   group_by(Número.Mesa) %>% 
#   filter(value == max(value), Sospecha=="Sospechosa") %>^
#   mutate(
#     Tipo.de.Voto_otros = ifelse(!(Tipo.de.Voto %in% c("CC", "MAS...IPSP")),
#       "Otros_Ganadores", Tipo.de.Voto)) 
# %>% ggplot(mapping = aes(Tipo.de.Voto_otros)) + 
#   geom_bar(mapping = aes(y=..count../sum(..count..)*100)) +
#   geom_col(data = p_ganadores_mesas, 
#       aes(x = Tipo.de.Voto, y = value, fill = Tipo.de.Voto), 
#       alpha = 0.35, position = "dodge"
#       )
```

Further verification of this hypothesis namely requiring seeing whether the suppresed/increased votes per booth were indeed **penalizing for CC and beneficial to MAS-IPSP** require a comparison between the **PRES** and **TREP** samples. 

## Comparison between rapid counting and full report of the election results : the **TREP** vs. **PRES** samples.

```{r}
actas_trep <- read.csv("./datasets/acta.2019.10.22.20.38.53.csv")

actas_pres_trep <- actas_trep %>%  
  filter(
    Elección  == "Presidente y Vicepresidente"
    )

actas_pres_trep$Votos.Partidos <- 
  actas_pres_trep[,partidos] %>% 
  rowSums()

actas_pres_trep$Votos.Emitidos <- 
  actas_pres_trep[,emitidos] %>% 
  rowSums()

actas_pres_trep$Diferencia.Partidos <- 
  actas_pres_trep$Votos.Partidos - actas_pres_trep$Votos.Válidos

actas_pres_trep %>% 
  mutate(
    Sospecha = ifelse(
      Diferencia.Partidos!=0,"Sospechosa","Normal"), 
    Sampl = "pres"
    ) -> actas_pres_trep

Total.Sospechas_trep <- sum(actas_pres_trep$Sospecha=="Sospechosa") 

actas_pres_trep %>% 
  filter(Sospecha == "Sospechosa")  %>%
  select(Diferencia.Partidos) %>%
  abs() %>%
  sum() -> Votos.Sospechosos_trep

actas_pres_trep %>% 
  select(Votos.Emitidos) %>% 
  sum() -> Total.Emitidos_trep
```

- A total of `r Total.Sospechas_trep` booths were deemed as supicious. Given that the total amount of booths is `r nrow(actas_pres_trep)`, this amount represents `r round(Total.Sospechas_trep/nrow(actas_pres_trep)*100, digits = 2)`% of the total number of booths.  
- A total of `r Votos.Sospechosos_trep` were votes miscounted, be it in the positive or negative sense. That is over a total of `r Total.Emitidos_trep` accounted up to that point, `r round(Votos.Sospechosos_trep/Total.Emitidos_trep*100, digits = 2)`% of the total amount of votes. 

The summary goes as follows:

```{r}
actas_pres_trep %>% 
  filter(Sospecha == "Sospechosa")  %>%
  select(Diferencia.Partidos) %>% mysum() %>% kable() %>% kable_styling()
```

More votes are negatively corrected in this sample

```{r, message = FALSE}
actas_pres %>% 
  mutate(Computo = "Computo Final") -> actas_pres

actas_pres_trep %>% 
  mutate(Computo = "Conteo Rapido (TREP)") -> actas_pres_trep

actas_pres %>% 
  filter(Número.Mesa %in% actas_pres_trep$Número.Mesa) -> 
  actas_pres_mtch

# both datasets match

actas_pres_diff <- 
  select(actas_pres_mtch, emitidos) - select(actas_pres_trep, emitidos) 

actas_pres_diff %>% abs() %>% rowSums() -> alterations

actas_pres_mtch %>%
  mutate(alterations = ifelse(alterations!=0, "Altered", "Normal")) -> 
  actas_pres_mtch 

actas_pres_mtch[,emitidos] <- actas_pres_diff

actas_pres_mtch  %>% 
  filter(alterations == "Altered") -> actas_pres_altr
```

We now focus on the booths where the results of the vote differ, i.e. those that experience 'alterations' in the words of Villegas. Below is a plot that shows the sense of the alterations (increase or supresion) for the different parties. 

```{r}
actas_pres_altr %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  mutate(
    Alteration = ifelse(value>0, "Incremento", "Supresión")
    ) %>%
  ggplot(mapping = aes(Tipo.de.Voto, fill= Alteration)) + 
  geom_bar(position = "dodge")
```

The plot shows that all the parties show more instances where their votes were reduced in the final computation. The computation was corrected with an increase in less cases. 

```{r}
actas_pres_altr %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  mutate(
    Alteration = ifelse(value>0, "Incremento", "Supresión")
    ) %>%
  filter(Alteration == "Incremento") %>%
  group_by(Tipo.de.Voto) %>% 
  summarise(Total.Incrementos = sum(value)) %>% 
  ggplot() + 
  geom_col(mapping = aes(x = Tipo.de.Voto, y =  Total.Incrementos), fill = "blue")
```


```{r}
actas_pres_altr %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  mutate(
    Alteration = ifelse(value>0, "Incremento", "Supresión")
    ) %>%
  filter(Alteration == "Supresión") %>%
  group_by(Tipo.de.Voto) %>% 
  summarise(Total.Supresiones = sum(value)) %>% 
  ggplot() + 
  geom_col(mapping = aes(x = Tipo.de.Voto, y =  Total.Supresiones), fill= "red")
```

```{r}
actas_pres_altr %>%
  melt(measure.vars  = emitidos,
       variable_name= "Tipo.de.Voto"
       ) %>% 
  group_by(Tipo.de.Voto) %>% 
  summarise(Total.Supresiones = sum(value)) %>% 
  ggplot() + 
  geom_col(mapping = aes(x = Tipo.de.Voto, y =  Total.Supresiones) , fill="purple")
```

All the candidates seem to show the same amount of positive alterations, yet the negative are a bit more variable.

Una hipótesis que se puede manejar a este punto es la transferencia de votos, i.e. que los votos disminuidos a CC correspondan a algún incremento en los votos del MAS-IPSP o se transformen en Nulos o Blancos. A continuación una tabulación de las proporciones de esos escenarios, por el momento **sin consideración de la cantidad de votos transferidos**:

### Transferencia de CC a MAS-IPSP

```{r}
actas_pres_altr %>%
  mutate(
    BeneficiaCC   = ifelse(CC>0, "Aumentan", "Pierden"),
    BeneficiaMAS  = ifelse(MAS...IPSP >0, "Aumentan", "Pierden")
    ) %>% 
  select(BeneficiaCC, BeneficiaMAS) %>% 
  table()/nrow(actas_pres_altr)*100 -> tab_cc_mas

tab_cc_mas
```

Aproximadamente `r round(tab_cc_mas[2,1], digits = 2)`% de instancias de transferencia de votos. `r round(tab_cc_mas[1,2], digits = 2)`% de instancias en el otro sentido

### Transferencia de CC a Blancos

```{r}
actas_pres_altr %>%
  mutate(
    BeneficiaCC   = ifelse(CC>0, "Aumentan", "Pierden"),
    BeneficiaBlancos  = ifelse(Blancos >0, "Aumentan", "Pierden")
    ) %>% 
  select(BeneficiaCC, BeneficiaBlancos) %>% 
  table()/nrow(actas_pres_altr)*100   -> tab_cc_bln

tab_cc_bln
```

Aproximadamente `r round(tab_cc_bln[2,1], digits = 2)`% de instancias de votos transpuestos a blancos. 
`r round(tab_cc_bln[1,2], digits = 2)`% en el otro sentido.

### Transferencia de CC a Nulos

```{r}
actas_pres_altr %>%
  mutate(
    BeneficiaCC   = ifelse(CC>0, "Aumentan", "Pierden"),
    BeneficiaNulos  = ifelse(Nulos >0, "Aumentan", "Pierden")
    ) %>% 
  select(BeneficiaCC, BeneficiaNulos) %>% 
  table()/nrow(actas_pres_altr)*100  -> tab_cc_nls
tab_cc_nls
```

Aproximadamente `r round(tab_cc_nls[2,1], digits = 2)`% de instancias de votos transpuestos anulados. 
`r round(tab_cc_nls[1,2], digits = 2)`% en el otro sentido.

### Transferencia de Blancos a MAS-IPSP

```{r}
actas_pres_altr %>%
  mutate(
    BeneficiaMAS   = ifelse(MAS...IPSP>0, "Aumentan", "Pierden"),
    BeneficiaBlancos  = ifelse(Blancos >0, "Aumentan", "Pierden")
    ) %>% 
  select(BeneficiaMAS, BeneficiaBlancos) %>% 
  table()/nrow(actas_pres_altr)*100  -> tab_bln_mas
tab_bln_mas
```

### Transferencia de Nulos a MAS-IPSP

```{r}
actas_pres_altr %>%
  mutate(
    BeneficiaMAS   = ifelse(MAS...IPSP>0, "Aumentan", "Pierden"),
    BeneficiaNulos  = ifelse(Nulos >0, "Aumentan", "Pierden")
    ) %>% 
  select(BeneficiaMAS, BeneficiaNulos) %>% 
  table()/nrow(actas_pres_altr)*100  -> tab_nls_mas
tab_nls_mas
```

Next step is checking the **amounts**, but I'm a bit tired for that.

## Overviewing voting per Polling Districts 

In this part, we try to check whether there is a difference between the results of voting at each booth within a precint and the results of the precint. One would expect that the distribution of the former is somehow reflective of the latter. This can be assessed graphically or via testing procedures with the respective corrections. 

However, booths with a small amount of voters:

1. Could have a problem reflecting the distribution of the precint as they are small samples.
2. Hinder the statistical testing process.

```{r}
ComoVotaMiRecinto <- function(recinto, porcentajes =FALSE){
   if(!(recinto %in% levels(actas$Recinto))) {
     stop(message("Nombre de recinto no valido."))
   } else {
     data <- actas_pres %>% melt(
       measure.vars  = partidos,
       variable_name= "Partido") %>%
       mutate(
         Porcentaje.por.Partido =  value/Votos.Emitidos*100) %>%
       filter(
         Recinto  == recinto) %>%
       group_by(Número.Mesa, Partido)
      if(!porcentajes){
        plots <- data %>% 
          ggplot(mapping = aes(x = Partido, 
                               y=value, 
                               fill = factor(Número.Mesa))) +
          geom_col(position ="dodge")+
          facet_grid(.~Departamento+Provincia+Localidad+Sospecha, 
                     scales = "free_y") + 
          ggtitle(paste("Localidad :", recinto, "- Total")) + 
          labs(x = "Partido", y = "Total de Votos")
       } else if (porcentajes){
         plots <- data %>% 
           ggplot(mapping = aes(x = Partido, 
                                y = Porcentaje.por.Partido, 
                                fill = factor(Número.Mesa))) +
           geom_col(position ="dodge")+
           facet_grid(.~Departamento+Provincia+Localidad+Sospecha, scales = "free_y") + 
           ggtitle(paste("Localidad :", recinto, "- Porcentaje por Mesa"))+ 
           labs(x = "Partido", y = "Porcentaje de Votos")
       }
     plots
   }
}
```

### Some Examples

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Colegio German Busch", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio German Busch", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Escuela Carlos Medinaceli", porcentajes = FALSE)
ComoVotaMiRecinto("Escuela Carlos Medinaceli", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Colegio Bolivia", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio Bolivia", porcentajes = TRUE)
```


```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Escuela Simón Bolivar", porcentajes = FALSE)
ComoVotaMiRecinto("Escuela Simón Bolivar", porcentajes = TRUE)
```


```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Escuela Alto Achumani", porcentajes = FALSE)
ComoVotaMiRecinto("Escuela Alto Achumani", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("U. E. Ff. Aa. De La Nación", porcentajes = FALSE)
ComoVotaMiRecinto("U. E. Ff. Aa. De La Nación", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Esc. San Jose", porcentajes = FALSE)
ComoVotaMiRecinto("Esc. San Jose", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("U.E. Ignacio Warnes", porcentajes = FALSE)
ComoVotaMiRecinto("U.E. Ignacio Warnes", porcentajes = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
ComoVotaMiRecinto("Colegio 6 de Junio", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio 6 de Junio", porcentajes = TRUE)
```

```{r, echo = FALSE}
ComoVotaMiRecinto("Colegio Simon Bolivar", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio Simon Bolivar", porcentajes = TRUE)
```

```{r}
ComoVotaMiRecinto("Colegio Simon Bolivar", porcentajes = FALSE)
ComoVotaMiRecinto("Colegio Simon Bolivar", porcentajes = TRUE)
```




```{r, eval = FALSE}
ComoVotaMiRecinto <- function(recinto, porcentajes =FALSE, aggregation= FALSE){
   if(!(recinto %in% levels(actas$Recinto))) {
     stop(message("Nombre de recinto no valido."))
   } else {
     otpbn <-c("FPV","MTS","UCS","X21F","PDC","MNR","PAN.BOL","Nulos", "Blancos")
     data <- actas_pres %>% melt(
       measure.vars  = partidos,
       variable_name= "Partido") %>%
       mutate(
         Porcentaje.por.Partido =  value/Votos.Emitidos*100,
         Partido.OBN = ifelse((Partido %in% otpbn), "Otros-Blanco-Nulo", Partido)
         ) %>%
       filter(
         Recinto  == recinto) %>%
       group_by(Número.Mesa, Partido, Partido.OBN)
      if(!porcentajes){
        plots <- data %>% 
          ggplot(mapping = aes(x = ifelse(!aggregation,Partido,Partido.OBN), 
                               y=value, 
                               fill = factor(Número.Mesa))) +
          geom_col(position ="dodge")+
          facet_grid(.~Departamento+Provincia+Localidad+Sospecha, 
                     scales = "free_y") + 
          ggtitle(paste("Localidad :", recinto, "- Total")) + 
          labs(x = "Partido", y = "Total de Votos")
       } else if (porcentajes){
         plots <- data %>% 
           ggplot(mapping = aes(x = ifelse(!aggregation,Partido,Partido.OBN), 
                                y = Porcentaje.por.Partido, 
                                fill = factor(Número.Mesa))) +
           geom_col(position ="dodge")+
           facet_grid(.~Departamento+Provincia+Localidad+Sospecha, scales = "free_y") + 
           ggtitle(paste("Localidad :", recinto, "- Porcentaje por Mesa"))+ 
           labs(x = "Partido", y = "Porcentaje de Votos")
       }
     plots
   }
}
```